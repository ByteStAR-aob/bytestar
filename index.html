<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ByteStAR - Ai-TONE (Local)</title>
<style>
:root{
  --bg:#0b0f14; --card:#0f1720; --muted:#9aa6b2;
  --accent1: #00d4ff; --accent2:#6a00ff;
  --glow: 0 8px 30px rgba(0,212,255,0.12);
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial;background:linear-gradient(180deg,#05060a 0%, #08111a 100%);color:#e6eef6}
.header{
  display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.03);
  backdrop-filter: blur(6px);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:42px;height:42px;border-radius:8px;background:linear-gradient(135deg,var(--accent1),var(--accent2));
  display:flex;align-items:center;justify-content:center;color:#03121b;font-weight:800;box-shadow:var(--glow);
  font-family:monospace;
}
.title{font-weight:700;font-size:18px;letter-spacing:0.6px}
.header-right{display:flex;align-items:center;gap:10px}
.icon-btn{
  background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:10px;color:var(--accent1);cursor:pointer;
  display:flex;align-items:center;gap:8px;backdrop-filter:blur(6px)
}
.icon-btn.lock{color:#ffd36a}
.container{padding:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:14px;overflow:hidden;box-shadow:0 6px 30px rgba(0,0,0,0.6);position:relative;
  transition:transform .22s ease, box-shadow .22s ease;
  border:1px solid rgba(255,255,255,0.03);
}
.card:hover{transform:translateY(-6px);box-shadow:0 20px 50px rgba(0,0,0,0.7)}
.cover{
  width:100%;aspect-ratio:1/1;display:block;object-fit:cover;background:#0b0f14;
  box-shadow: inset 0 -30px 60px rgba(0,0,0,0.55);
  position:relative;
}
.card-meta{padding:12px 14px;display:flex;flex-direction:column;gap:10px}
.p-title{font-weight:700;font-size:15px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  padding:8px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer;font-weight:700;
  font-size:13px;
}
.btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#02111a;box-shadow:var(--glow)}
.btn.danger{background:linear-gradient(90deg,#ff6b6b,#ff9a6b);color:white}
.lock-badge{position:absolute;top:10px;left:10px;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.5);color:#ffd36a;font-weight:700;border:1px solid rgba(255,255,255,0.04)}
.fab{
  position:fixed;right:28px;bottom:28px;width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));
  border:none;color:#02111a;font-size:34px;box-shadow:0 12px 40px rgba(0,212,255,0.18);cursor:pointer;
  display:flex;align-items:center;justify-content:center;z-index:60;
}
.modal-back{position:fixed;inset:0;background:rgba(2,6,10,0.6);display:none;align-items:center;justify-content:center;z-index:80}
.modal{width:92%;max-width:900px;background:linear-gradient(180deg,#061017, #07151f);border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.8)}
.form-row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.input, textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit;font-size:14px}
textarea{min-height:240px;font-family:Menlo,monospace;resize:vertical}
.small{font-size:13px;color:var(--muted)}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.lock-list{padding:12px;display:flex;flex-direction:column;gap:8px}
.notice{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;color:var(--muted);font-size:13px}
.row{display:flex;gap:8px;align-items:center}
.input-file{display:none}
.thumbnail{width:60px;height:60px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
.top-actions{display:flex;gap:8px;align-items:center}

.footer{padding:14px;color:var(--muted);font-size:13px;text-align:center}
small.hint{color:var(--muted);font-size:12px;margin-top:6px;display:block}

@media(max-width:600px){
  .header{padding:10px}
  .title{font-size:16px}
  .container{padding:10px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
  .fab{width:56px;height:56px;right:18px;bottom:18px}
}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">BS</div>
      <div>
        <div class="title">ByteStAR - Ai-TONE</div>
        <div class="small">Create HTML projects ‚Ä¢ Store covers ‚Ä¢ Password-lock</div>
      </div>
    </div>
    <div class="header-right">
      <button class="icon-btn" id="importBtn">Import</button>
      <button class="icon-btn lock" id="vaultBtn">üîí Vault</button>
    </div>
  </div>

  <main id="main" class="container"></main>

  <div class="footer">
    <button class="btn" id="clearBtn">Clear All (dev)</button>
    <small class="hint">Projects are stored locally in your browser (localStorage). Locked projects require their password to open.</small>
  </div>

  <button class="fab" id="newBtn">+</button>

  <!-- Modal for editor -->
  <div class="modal-back" id="editorModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800">Create / Edit Project</div>
        <div class="toolbar">
          <button class="btn" id="previewBtn">Preview</button>
          <button class="btn" id="cancelEdit">Close</button>
        </div>
      </div>
      <div class="form-row">
        <input class="input" id="projTitle" placeholder="Project Title" />
        <label class="icon-btn" style="cursor:pointer">
          <input type="file" accept="image/*" id="coverInput" class="input-file" />
          Upload Cover
        </label>
      </div>
      <div style="margin-bottom:8px" class="small">Cover will be saved at 3000√ó3000 (scaled) so it can be used as a high-res thumbnail or downloaded.</div>
      <textarea id="htmlEditor" placeholder="Paste your HTML here (full page or snippet)"></textarea>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="saveBtn">üíæ Save</button>
        <button class="btn danger" id="cancelSave">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Lock prompt modal -->
  <div class="modal-back" id="lockModal">
    <div class="modal">
      <div style="font-weight:800">üîê Lock this Project?</div>
      <div class="notice">Choose a password to encrypt and lock this file. You will need this password to open or share the file later.</div>
      <div class="form-row" style="margin-top:12px">
        <input class="input" id="lockPass" placeholder="Enter password to lock (min 4 chars)" type="password" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn primary" id="confirmLock">Yes, Lock it</button>
        <button class="btn" id="skipLock">No, skip</button>
      </div>
    </div>
  </div>

  <!-- Vault modal -->
  <div class="modal-back" id="vaultModal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">üîí Locked Vault</div>
        <div class="small">Open a locked project by entering its password</div>
      </div>
      <div class="lock-list" id="vaultList"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <button class="btn" id="closeVault">Close</button>
      </div>
    </div>
  </div>

<script>
/* Storage structure:
projects: JSON object keyed by id {
 id: {id, title, imageData(base64), html, created, locked:bool, cipher/base64, salt/base64, iv/base64}
}
*/
const DB_KEY = 'bytstar_projects_v1';

function uid(){ return 'p_'+Math.random().toString(36).slice(2,10) }
function now(){ return Date.now() }

function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)) }
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{}') }catch(e){return {}} }
let db = loadDB();

const main = document.getElementById('main');
const newBtn = document.getElementById('newBtn');
const editorModal = document.getElementById('editorModal');
const lockModal = document.getElementById('lockModal');
const vaultModal = document.getElementById('vaultModal');

const projTitle = document.getElementById('projTitle');
const htmlEditor = document.getElementById('htmlEditor');
const coverInput = document.getElementById('coverInput');
const saveBtn = document.getElementById('saveBtn');
const cancelSave = document.getElementById('cancelSave');
const confirmLock = document.getElementById('confirmLock');
const skipLock = document.getElementById('skipLock');
const lockPass = document.getElementById('lockPass');
const vaultBtn = document.getElementById('vaultBtn');
const vaultList = document.getElementById('vaultList');
const importBtn = document.getElementById('importBtn');

let editingId = null;
let stagedImageData = null; // base64 3000x3000

function openModal(mod){ mod.style.display='flex' }
function closeModal(mod){ mod.style.display='none' }

function render(){
  main.innerHTML='';
  const keys = Object.keys(db).sort((a,b)=>db[b].created-db[a].created);
  if(keys.length===0){
    const el = document.createElement('div');
    el.className='card'; el.style.padding='40px'; el.innerHTML='<div style="text-align:center"><strong>No projects yet</strong><div class="small" style="margin-top:6px">Click + to create your first HTML project</div></div>';
    main.appendChild(el); return;
  }
  keys.forEach(k=>{
    const p = db[k];
    const card = document.createElement('div'); card.className='card';
    const cover = document.createElement('img'); cover.className='cover';
    cover.src = p.imageData || placeholderData();
    cover.title = p.title;
    card.appendChild(cover);
    if(p.locked) {
      const lb = document.createElement('div'); lb.className='lock-badge'; lb.textContent='LOCKED';
      card.appendChild(lb);
    }
    const meta = document.createElement('div'); meta.className='card-meta';
    const t = document.createElement('div'); t.className='p-title'; t.textContent=p.title || 'Untitled Project';
    meta.appendChild(t);

    const actions = document.createElement('div'); actions.className='actions';
    const run = document.createElement('button'); run.className='btn primary'; run.textContent='RUN';
    run.onclick = ()=>runProject(k);
    const edit = document.createElement('button'); edit.className='btn'; edit.textContent='EDIT';
    edit.onclick = ()=>editProject(k);
    const del = document.createElement('button'); del.className='btn danger'; del.textContent='DELETE';
    del.onclick = ()=>{ if(confirm('Delete this project?')){ delete db[k]; saveDB(db); render(); } };
    const share = document.createElement('button'); share.className='btn'; share.textContent='SHARE';
    share.onclick = ()=>shareProject(k);
    actions.append(run, edit, share, del);
    meta.appendChild(actions);
    card.appendChild(meta);
    main.appendChild(card);
  });
}

function placeholderData(){
  // simple svg placeholder as data URL
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='#071218'/><text x='50%' y='50%' fill='#2dafff' font-size='18' text-anchor='middle' dominant-baseline='middle'>ByteStAR</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* Image processing: scale to square 3000x3000 */
function fileTo3000(file){
  return new Promise((res,rej)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e=>{
      img.onload = ()=>{
        try{
          const size = 3000;
          const canvas = document.createElement('canvas');
          canvas.width = size; canvas.height = size;
          const ctx = canvas.getContext('2d');
          // cover crop: fill canvas with image
          const ratio = Math.max(size/img.width, size/img.height);
          const w = img.width*ratio, h = img.height*ratio;
          const dx = (size-w)/2, dy=(size-h)/2;
          ctx.fillStyle='#071218'; ctx.fillRect(0,0,size,size);
          ctx.drawImage(img, dx, dy, w, h);
          const out = canvas.toDataURL('image/jpeg',0.92);
          res(out);
        }catch(err){ rej(err) }
      };
      img.onerror = ()=>rej(new Error('Invalid image'));
      img.src = e.target.result;
    };
    reader.onerror = ()=>rej(new Error('File read error'));
    reader.readAsDataURL(file);
  });
}

/* --- Crypto helpers using Web Crypto (AES-GCM + PBKDF2) --- */
async function deriveKey(password, salt, iterations=250000){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({
    name:'PBKDF2', salt: salt, iterations: iterations, hash: 'SHA-256'
  }, baseKey, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
}
function randBytes(len){ const b=new Uint8Array(len); crypto.getRandomValues(b); return b }
function toB64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))) }
function fromB64(b64){ const s=atob(b64); const a=new Uint8Array(s.length); for(let i=0;i<s.length;i++)a[i]=s.charCodeAt(i); return a.buffer }

/* Encrypt plaintext (string) with password -> returns {cipher, salt, iv} base64 */
async function encryptWithPassword(plaintext, password){
  const salt = randBytes(16);
  const iv = randBytes(12);
  const key = await deriveKey(password, salt);
  const enc = new TextEncoder();
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv: iv}, key, enc.encode(plaintext));
  return { cipher: toB64(ct), salt: toB64(salt), iv: toB64(iv) };
}
async function decryptWithPassword(cipherB64, password, saltB64, ivB64){
  const salt = fromB64(saltB64);
  const iv = fromB64(ivB64);
  const key = await deriveKey(password, salt);
  try{
    const ptBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv: new Uint8Array(iv)}, key, fromB64(cipherB64));
    const dec = new TextDecoder().decode(ptBuf);
    return dec;
  }catch(e){
    throw new Error('Decryption failed');
  }
}

/* Save flow */
saveBtn.addEventListener('click', async ()=>{
  const title = projTitle.value || 'Untitled Project';
  const html = htmlEditor.value || '<!-- empty -->';
  const id = editingId || uid();
  let imageData = stagedImageData || placeholderData();
  // create temp object
  const obj = { id, title, imageData, created: now(), locked:false, html };
  // Ask lock
  openModal(lockModal);
  // store temp on window for later
  window._pendingSave = obj;
});

confirmLock.addEventListener('click', async ()=>{
  const password = lockPass.value;
  if(!password || password.length<4){ alert('Password too short (min 4 chars)'); return; }
  const obj = window._pendingSave;
  // prepare JSON payload containing html + metadata
  const payload = JSON.stringify({ title: obj.title, html: obj.html, created: obj.created });
  const enc = await encryptWithPassword(payload, password);
  // save as locked: keep imageData visible but store cipher fields and no plaintext html
  obj.locked = true;
  obj.cipher = enc.cipher; obj.salt = enc.salt; obj.iv = enc.iv;
  delete obj.html;
  db[obj.id] = obj; saveDB(db); window._pendingSave = null;
  lockPass.value=''; closeModal(lockModal); closeModal(editorModal); render();
});
skipLock.addEventListener('click', ()=>{
  const obj = window._pendingSave;
  obj.locked = false;
  db[obj.id] = obj; saveDB(db); window._pendingSave=null;
  closeModal(lockModal); closeModal(editorModal); render();
});

/* Cover input */
coverInput.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    stagedImageData = await fileTo3000(f);
    // show small thumbnail while editing
    // (not necessary, but helpful)
    alert('Cover processed and staged (3000x3000).');
  }catch(err){ alert('Image processing failed: '+err.message) }
});

/* New project */
newBtn.addEventListener('click', ()=>{
  editingId=null; projTitle.value=''; htmlEditor.value=''; stagedImageData=null;
  openModal(editorModal);
});

/* Cancel editor */
document.getElementById('cancelEdit').addEventListener('click', ()=>closeModal(editorModal));
cancelSave.addEventListener('click', ()=>closeModal(editorModal));

/* Render vault */
vaultBtn.addEventListener('click', ()=>{ openModal(vaultModal); populateVault(); });

function populateVault(){
  vaultList.innerHTML='';
  const keys = Object.keys(db).filter(k=>db[k].locked).sort((a,b)=>db[b].created-db[a].created);
  if(keys.length===0){ vaultList.innerHTML='<div class="notice">No locked projects.</div>'; return; }
  keys.forEach(k=>{
    const p = db[k];
    const row = document.createElement('div'); row.className='row';
    const thumb = document.createElement('img'); thumb.className='thumbnail'; thumb.src=p.imageData||placeholderData();
    const info = document.createElement('div'); info.style.flex='1';
    info.innerHTML = `<div style="font-weight:700">${p.title||'Locked'}</div><div class="small">ID: ${p.id}</div>`;
    const openBtn = document.createElement('button'); openBtn.className='btn'; openBtn.textContent='Open';
    openBtn.onclick = ()=>unlockAndOpen(k);
    row.append(thumb, info, openBtn);
    vaultList.appendChild(row);
  });
}

/* Unlock flow for vault items */
async function unlockAndOpen(id){
  const pass = prompt('Enter password to open this project:');
  if(!pass) return;
  const p = db[id];
  try{
    const dec = await decryptWithPassword(p.cipher, pass, p.salt, p.iv);
    const obj = JSON.parse(dec);
    // create a temp object to run or edit
    // show action: open in editor with decrypted html
    const go = confirm('Password OK. Open for Edit? (Cancel to Run)');
    if(go){
      editingId = id;
      projTitle.value = obj.title || '';
      htmlEditor.value = obj.html || '';
      stagedImageData = p.imageData || null;
      closeModal(vaultModal); openModal(editorModal);
    }else{
      // run: open a window with the html
      const blob = new Blob([obj.html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }
  }catch(e){
    alert('Password incorrect or decryption failed.');
  }
}

/* Edit project (including locked) */
async function editProject(id){
  const p = db[id];
  if(p.locked){
    const pass = prompt('This project is locked. Enter password to edit:');
    if(!pass) return;
    try{
      const dec = await decryptWithPassword(p.cipher, pass, p.salt, p.iv);
      const obj = JSON.parse(dec);
      editingId = id; projTitle.value = obj.title || ''; htmlEditor.value = obj.html || ''; stagedImageData = p.imageData || null;
      openModal(editorModal);
    }catch(e){ alert('Password incorrect'); }
  }else{
    editingId = id; projTitle.value = p.title || ''; htmlEditor.value = p.html || ''; stagedImageData = p.imageData || null;
    openModal(editorModal);
  }
}

/* Run project (if locked ask for password) */
async function runProject(id){
  const p = db[id];
  if(p.locked){
    const pass = prompt('Enter password to run this locked project:');
    if(!pass) return;
    try{
      const dec = await decryptWithPassword(p.cipher, pass, p.salt, p.iv);
      const obj = JSON.parse(dec);
      const blob = new Blob([obj.html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }catch(e){ alert('Password incorrect'); }
  }else{
    const blob = new Blob([p.html || ''], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  }
}

/* Share project -> download .html file (if locked require password) */
async function shareProject(id){
  const p = db[id];
  if(p.locked){
    const pass = prompt('Enter password to export/decrypt this locked project:');
    if(!pass) return;
    try{
      const dec = await decryptWithPassword(p.cipher, pass, p.salt, p.iv);
      const obj = JSON.parse(dec);
      downloadFile(obj.html, (p.title||'project') + '.html');
      // also allow downloading cover
      if(p.imageData) downloadDataURL(p.imageData, (p.title||'cover')+'.jpg');
    }catch(e){ alert('Password incorrect'); }
  }else{
    downloadFile(p.html || '', (p.title||'project') + '.html');
    if(p.imageData) downloadDataURL(p.imageData, (p.title||'cover')+'.jpg');
  }
}

function downloadFile(text, filename){
  const blob = new Blob([text], {type:'text/html'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}
function downloadDataURL(dataurl, filename){
  const a = document.createElement('a'); a.href = dataurl; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}

/* Import: allow selecting an HTML file and saving as project */
importBtn.addEventListener('click', ()=>{
  const f = document.createElement('input'); f.type='file'; f.accept='.html,text/html'; f.onchange = async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const text = await file.text();
    editingId=null; projTitle.value = file.name.replace(/\.[^/.]+$/,''); htmlEditor.value = text; stagedImageData=null;
    openModal(editorModal);
  }; f.click();
});

/* Preview button inside editor: open a new tab with current editor HTML */
document.getElementById('previewBtn').addEventListener('click', ()=>{
  const txt = htmlEditor.value || '<!-- empty -->';
  const blob = new Blob([txt], {type:'text/html'}); const url = URL.createObjectURL(blob); window.open(url,'_blank');
});

/* When closing modal, clear staged image not necessary. When saving non-locked, need to fill html to db */
window.addEventListener('storage', ()=>{ db = loadDB(); render(); });

/* When editor modal opened for save (skip lock) we already write; but if editing and non-locked, should update html */
function ensureSavePending(){
  if(window._pendingSave) return;
}

/* Close vault */
document.getElementById('closeVault').addEventListener('click', ()=>closeModal(vaultModal));

/* Quick clear dev */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('Clear all projects from local storage?')){ localStorage.removeItem(DB_KEY); db={}; render(); }
});

/* Close modals when clicking backdrop */
document.querySelectorAll('.modal-back').forEach(m=>{
  m.addEventListener('click', (e)=>{ if(e.target===m) closeModal(m) });
});

/* On editor open, if editing existing non-locked, we need to allow overwrite save (editingId) */
editorModal.addEventListener('click', ()=>{}); //noop

/* On actual Save (after lock decision skip), if editing existing non-locked we must update */
window.addEventListener('beforeunload', ()=>{ saveDB(db) });

/* When editor opened for editing a non-locked project and user clicks 'skip lock' (which we used also for normal saves),
   ensure html is set. But when saving initially we set window._pendingSave with html already. For edits to unlocked item, staged pending contains id.
*/

/* Initialize db and render */
render();

/* Save flow note:
  - When Save clicked, window._pendingSave created then lockModal opened.
  - confirmLock encrypts and writes locked entry.
  - skipLock writes plaintext entry.
  - If editing existing unlocked project, id is preserved so entry is overwritten.
*/

</script>
</body>
</html>
